name: Deploy containers to container APPs

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Log in to Registry
              uses: docker/login-action@v2
              with:
                registry: chefcitoacr.azurecr.io
                username: ${{ secrets.GATEWAY_REGISTRY_USERNAME }}
                password: ${{ secrets.GATEWAY_REGISTRY_PASSWORD }}
      
            - name: build-push gateway
              uses: docker/build-push-action@v3
              with:
                file: containerfiles/gateway/CONTAINERFILE
                push: true
                tags: chefcitoacr.azurecr.io/gateway:latest

            - name: build-push users
              uses: docker/build-push-action@v3
              with:
              file: containerfiles/users/CONTAINERFILE
              push: true
              tags: chefcitoacr.azurecr.io/users:latest

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Log in to Azure
              uses: azure/login@v1
              with:
                client-id: ${{ secrets.GATEWAY_AZURE_CLIENT_ID }}
                subscription-id: ${{ secrets.GATEWAY_AZURE_SUBSCRIPTION_ID }}
                tenant-id: ${{ secrets.GATEWAY_AZURE_TENANT_ID }}
            - name: deploy gateway
              uses: azure/container-apps-deploy-action@v2
              with:
                imageToDeploy: chefcitoacr.azurecr.io/gateway:latest
                containerAppName: gateway
            - name: deploy users
              uses: azure/container-apps-deploy-action@v2
              with:
                imageToDeploy: chefcitoacr.azurecr.io/users:latest
                containerAppName: users


