name: Deploy containers to container APPs

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Log in to Registry
              uses: docker/login-action@v2
              with:
                registry: chefcitoacr.azurecr.io
                username: ${{ secrets.GATEWAY_REGISTRY_USERNAME }}
                password: ${{ secrets.GATEWAY_REGISTRY_PASSWORD }}
      
            - name: build-push gateway
              uses: docker/build-push-action@v3
              with:
                file: containerfiles/gateway/CONTAINERFILE
                push: true
                tags: chefcitoacr.azurecr.io/gateway:latest

            - name: build-push users
              uses: docker/build-push-action@v3
              with:
                file: containerfiles/users/CONTAINERFILE
                push: true
                tags: chefcitoacr.azurecr.io/users:latest

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Log in to Azure
              uses: azure/login@v1
              with:
                creds: ${{secrets.AZURE_CREDENTIALS}}
            - name: deploy gateway
              uses: azure/cli@v2
              with:
                  azcliversion: latest
                  inlineScript: |
                    az containerapp revision copy -n gateway -g chefcito-rg --revision-suffix ${{ github.sha }}
            - name: deploy users 
              uses: azure/cli@v2
              with:
                  azcliversion: latest
                  inlineScript: |
                    az containerapp revision copy -n users -g chefcito-rg --revision-suffix ${{ github.sha }}
            
